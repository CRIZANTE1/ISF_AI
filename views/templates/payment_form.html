<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        .payment-container {{
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }}
        
        .form-group {{
            margin-bottom: 16px;
        }}
        
        .form-control {{
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }}
        
        .form-control:focus {{
            outline: none;
            border-color: #009ee3;
            box-shadow: 0 0 0 3px rgba(0, 158, 227, 0.1);
        }}
        
        .btn-pay {{
            width: 100%;
            background: linear-gradient(135deg, #009ee3 0%, #0080b8 100%);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }}
        
        .btn-pay:hover {{
            background: linear-gradient(135deg, #0080b8 0%, #006a9a 100%);
            transform: translateY(-1px);
        }}
        
        .btn-pay:disabled {{
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }}
        
        .form-row {{
            display: flex;
            gap: 12px;
        }}
        
        .form-row .form-group {{
            flex: 1;
        }}
        
        .alert {{
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }}
        
        .alert-error {{
            background-color: #fee;
            color: #d63384;
            border: 1px solid #f5c2c7;
        }}
        
        .alert-success {{
            background-color: #d1e7dd;
            color: #0a3622;
            border: 1px solid #a3cfbb;
        }}
        
        .loading {{
            text-align: center;
            color: #666;
            font-style: italic;
        }}
        
        .security-badge {{
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 16px;
            font-size: 12px;
            color: #666;
        }}
        
        .security-badge::before {{
            content: "ðŸ”’";
            margin-right: 4px;
        }}
        
        label {{
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }}
    </style>
</head>
<body>
    <div class="payment-container">
        <form id="form-checkout">
            <div class="form-group">
                <label for="cardNumber">NÃºmero do CartÃ£o</label>
                <input type="text" id="form-checkout__cardNumber" class="form-control" placeholder="1234 1234 1234 1234">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="expirationDate">Validade</label>
                    <input type="text" id="form-checkout__expirationDate" class="form-control" placeholder="MM/AA">
                </div>
                <div class="form-group">
                    <label for="securityCode">CVV</label>
                    <input type="text" id="form-checkout__securityCode" class="form-control" placeholder="123">
                </div>
            </div>
            
            <div class="form-group">
                <label for="cardholderName">Nome no CartÃ£o</label>
                <input type="text" id="form-checkout__cardholderName" class="form-control" placeholder="Como aparece no cartÃ£o" value="{user_name}">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="identificationType">Tipo de Documento</label>
                    <select id="form-checkout__identificationType" class="form-control">
                        <option value="">Selecione</option>
                        <option value="CPF">CPF</option>
                        <option value="CNPJ">CNPJ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="identificationNumber">NÃºmero do Documento</label>
                    <input type="text" id="form-checkout__identificationNumber" class="form-control" placeholder="000.000.000-00">
                </div>
            </div>
            
            <div class="form-group">
                <label for="installments">Parcelas</label>
                <select id="form-checkout__installments" class="form-control">
                    <option value="">Carregando parcelas...</option>
                </select>
            </div>
            
            <button type="submit" id="form-checkout__submit" class="btn-pay">
                ðŸ’³ Pagar R$ {price}
            </button>
            
            <div class="security-badge">
                Pagamento 100% seguro e criptografado
            </div>
            
            <div id="form-checkout__error" class="alert alert-error" style="display: none;"></div>
            <div id="form-checkout__success" class="alert alert-success" style="display: none;"></div>
            <div id="form-checkout__loading" class="loading" style="display: none;">
                Processando seu pagamento...
            </div>
        </form>
    </div>

    <script>
        const mp = new MercadoPago('{public_key}', {{
            locale: 'pt-BR'
        }});
        
        const cardForm = mp.cardForm({{
            form: {{
                id: "form-checkout",
                cardNumber: {{
                    id: "form-checkout__cardNumber",
                    placeholder: "NÃºmero do cartÃ£o",
                }},
                expirationDate: {{
                    id: "form-checkout__expirationDate", 
                    placeholder: "MM/AA",
                }},
                securityCode: {{
                    id: "form-checkout__securityCode",
                    placeholder: "CÃ³digo de seguranÃ§a",
                }},
                cardholderName: {{
                    id: "form-checkout__cardholderName",
                    placeholder: "Titular do cartÃ£o",
                }},
                issuer: {{
                    id: "form-checkout__issuer",
                    placeholder: "Banco emissor",
                }},
                installments: {{
                    id: "form-checkout__installments",
                    placeholder: "Parcelas",
                }},
                identificationType: {{
                    id: "form-checkout__identificationType",
                    placeholder: "Tipo de documento",
                }},
                identificationNumber: {{
                    id: "form-checkout__identificationNumber", 
                    placeholder: "NÃºmero do documento",
                }},
            }},
            callbacks: {{
                onFormMounted: error => {{
                    if (error) {{
                        console.warn("Callback onFormMounted: ", error);
                        showError("Erro ao carregar o formulÃ¡rio. Recarregue a pÃ¡gina.");
                    }}
                }},
                onSubmit: event => {{
                    event.preventDefault();
                    processPayment();
                }},
                onFetching: (resource) => {{
                    console.log("Fetching resource: ", resource);
                }}
            }}
        }});
        
        function showError(message) {{
            const errorDiv = document.getElementById("form-checkout__error");
            errorDiv.innerHTML = "âŒ " + message;
            errorDiv.style.display = "block";
            
            // Ocultar apÃ³s 5 segundos
            setTimeout(() => {{
                errorDiv.style.display = "none";
            }}, 5000);
        }}
        
        function showSuccess(message) {{
            const successDiv = document.getElementById("form-checkout__success");
            successDiv.innerHTML = "âœ… " + message;
            successDiv.style.display = "block";
        }}
        
        function showLoading(show) {{
            const loadingDiv = document.getElementById("form-checkout__loading");
            const submitBtn = document.getElementById("form-checkout__submit");
            
            loadingDiv.style.display = show ? "block" : "none";
            submitBtn.disabled = show;
            
            if (!show) {{
                submitBtn.innerHTML = "ðŸ’³ Pagar R$ {price}";
            }} else {{
                submitBtn.innerHTML = "Processando...";
            }}
        }}
        
        async function processPayment() {{
            try {{
                showLoading(true);
                hideMessages();
                
                const cardData = cardForm.getCardFormData();
                
                if (!cardData.token) {{
                    throw new Error("Token do cartÃ£o nÃ£o foi gerado corretamente.");
                }}
                
                // Preparar dados do pagamento
                const paymentData = {{
                    plan_type: "{plan_type}",
                    user_email: "{user_email}",
                    user_name: "{user_name}",
                    card_token: cardData.token,
                    installments: parseInt(cardData.installments),
                    payment_method_id: cardData.payment_method_id,
                    issuer_id: cardData.issuer_id
                }};
                
                console.log("Enviando pagamento:", {{...paymentData, card_token: "***"}});
                
                // Enviar para o backend
                const response = await fetch("{api_url}/create-payment", {{
                    method: "POST",
                    headers: {{
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    }},
                    body: JSON.stringify(paymentData)
                }});
                
                const result = await response.json();
                
                if (!response.ok) {{
                    throw new Error(result.detail || "Erro ao processar pagamento");
                }}
                
                // Processar resultado
                switch (result.status) {{
                    case "approved":
                        showSuccess("Pagamento aprovado! Redirecionando...");
                        setTimeout(() => {{
                            window.parent.postMessage({{
                                type: "payment_success",
                                payment_id: result.payment_id,
                                plan_type: result.plan_type
                            }}, "*");
                        }}, 2000);
                        break;
                        
                    case "pending":
                        showSuccess("Pagamento em anÃ¡lise. VocÃª serÃ¡ notificado por email quando for aprovado.");
                        setTimeout(() => {{
                            window.parent.postMessage({{
                                type: "payment_pending", 
                                payment_id: result.payment_id
                            }}, "*");
                        }}, 3000);
                        break;
                        
                    case "in_process":
                        showSuccess("Pagamento em processamento. Aguarde a confirmaÃ§Ã£o.");
                        break;
                        
                    default:
                        throw new Error(result.status_detail || "Pagamento nÃ£o foi aprovado");
                }}
                
            }} catch (error) {{
                console.error("Erro no pagamento:", error);
                showError(error.message || "Erro inesperado. Tente novamente.");
            }} finally {{
                showLoading(false);
            }}
        }}
        
        function hideMessages() {{
            document.getElementById("form-checkout__error").style.display = "none";
            document.getElementById("form-checkout__success").style.display = "none";
        }}
    </script>
</body>
</html>
